syntax = "proto3";

package payment;

service PaymentService {
  // Payment CRUD operations
  rpc InitiatePayment (InitiatePaymentRequest) returns (PaymentResponse);
  rpc ConfirmPayment (ConfirmPaymentRequest) returns (PaymentResponse);
  rpc GetPaymentById (PaymentIdRequest) returns (PaymentResponse);
  rpc GetAllPayments (PaginationRequest) returns (PaginatedPaymentListResponse);
  rpc GetPaymentsByInvoice (InvoiceIdRequest) returns (PaymentListResponse);
  rpc GetPaymentStats (Empty) returns (PaymentStatsResponse);
  rpc ProcessPayment (ProcessPaymentRequest) returns (ProcessPaymentResponse);
  
  // =================== STRIPE OPERATIONS ===================
  rpc CreateCheckoutSession (CreateCheckoutSessionRequest) returns (CheckoutSessionResponse);
  rpc CreateSubscriptionCheckout (CreateSubscriptionCheckoutRequest) returns (CheckoutSessionResponse);
  rpc CreateSubscriptionPaymentCheckout (CreateSubscriptionPaymentCheckoutRequest) returns (SubscriptionPaymentCheckoutResponse);
  rpc CreatePaymentIntent (CreatePaymentIntentRequest) returns (PaymentIntentResponse);
  rpc CreateRefund (CreateRefundRequest) returns (RefundResponse);
  rpc HandleStripeWebhook (StripeWebhookRequest) returns (StripeWebhookResponse);
  rpc GetOrCreateCustomer (GetOrCreateCustomerRequest) returns (CustomerResponse);
  rpc CreateBillingPortalSession (BillingPortalRequest) returns (BillingPortalResponse);
  rpc CancelStripeSubscription (CancelStripeSubscriptionRequest) returns (CancelSubscriptionResponse);
}

// Common messages
message Empty {}

// Pagination messages
message PaginationRequest {
  int32 page = 1;
  int32 limit = 2;
}

message PaginationMeta {
  int32 page = 1;
  int32 limit = 2;
  int32 total = 3;
  int32 totalPages = 4;
  bool hasNext = 5;
  bool hasPrev = 6;
}

// Payment messages
message Payment {
  string id = 1;
  string invoiceId = 2;
  optional string orderId = 3;
  optional string customerId = 4;
  double totalAmount = 5;
  string status = 6;
  string method = 7;
  optional string transactionId = 8;
  optional string failureReason = 9;
  optional string paidAt = 10;
  string createdAt = 11;
  string updatedAt = 12;
}

message InitiatePaymentRequest {
  string invoiceId = 1;
  optional string orderId = 2;
  optional string customerId = 3;
  double amount = 4;
  string method = 5;
}

message ConfirmPaymentRequest {
  string paymentId = 1;
  string status = 2;
  optional string transactionId = 3;
  optional double amount = 4;
  optional string failureReason = 5;
}

message PaymentIdRequest {
  string id = 1;
}

message InvoiceIdRequest {
  string invoiceId = 1;
}

message PaymentResponse {
  Payment payment = 1;
}

message PaymentListResponse {
  repeated Payment payments = 1;
}

message PaginatedPaymentListResponse {
  repeated Payment payments = 1;
  PaginationMeta pagination = 2;
}

message PaymentStatsResponse {
  int32 totalPayments = 1;
  int32 successfulPayments = 2;
  int32 failedPayments = 3;
  int32 pendingPayments = 4;
  double totalAmount = 5;
  double successfulAmount = 6;
}

message ProcessPaymentRequest {
  string invoiceId = 1;
  double amount = 2;
  string paymentMethod = 3;
}

message ProcessPaymentResponse {
  bool success = 1;
  string message = 2;
  Payment payment = 3;
  optional string subscriptionId = 4;
}

// =================== STRIPE MESSAGES ===================

// Checkout Session
message LineItem {
  string productId = 1;
  string name = 2;
  int64 price = 3;  // Price in smallest currency unit (cents)
  int32 quantity = 4;
  optional string description = 5;
  optional string imageUrl = 6;
}

message CreateCheckoutSessionRequest {
  string customerId = 1;
  string orderId = 2;
  repeated LineItem items = 3;
  string successUrl = 4;
  string cancelUrl = 5;
  optional string currency = 6;
  map<string, string> metadata = 7;
}

message CreateSubscriptionCheckoutRequest {
  string customerId = 1;
  string priceId = 2;  // Stripe Price ID
  string successUrl = 3;
  string cancelUrl = 4;
  optional int32 trialDays = 5;
  map<string, string> metadata = 6;
}

message CreateSubscriptionPaymentCheckoutRequest {
  string customerId = 1;
  string email = 2;
  int64 amount = 3;  // Amount in smallest currency unit (cents)
  optional string currency = 4;
  optional string subscriptionId = 5;
  optional string planName = 6;
  optional string successUrl = 7;
  optional string cancelUrl = 8;
}

message CheckoutSessionResponse {
  string sessionId = 1;
  string checkoutUrl = 2;
  bool success = 3;
  optional string message = 4;
}

message SubscriptionPaymentCheckoutResponse {
  string sessionId = 1;
  string url = 2;
}

// Payment Intent
message CreatePaymentIntentRequest {
  int64 amount = 1;  // Amount in smallest currency unit
  string currency = 2;
  optional string customerId = 3;
  optional string orderId = 4;
  map<string, string> metadata = 5;
  optional string paymentMethodType = 6;
}

message PaymentIntentResponse {
  string paymentIntentId = 1;
  string clientSecret = 2;
  string status = 3;
  bool success = 4;
  optional string message = 5;
}

// Refund
message CreateRefundRequest {
  string paymentIntentId = 1;
  optional int64 amount = 2;  // Partial refund amount, null for full
  optional string reason = 3;
}

message RefundResponse {
  string refundId = 1;
  int64 amount = 2;
  string status = 3;
  bool success = 4;
  optional string message = 5;
}

// Webhook
message StripeWebhookRequest {
  bytes rawBody = 1;
  string signature = 2;
}

message StripeWebhookResponse {
  bool received = 1;
  string eventType = 2;
  optional string message = 3;
}

// Customer
message GetOrCreateCustomerRequest {
  string userId = 1;
  string email = 2;
  optional string name = 3;
}

message CustomerResponse {
  string stripeCustomerId = 1;
  bool isNew = 2;
  bool success = 3;
}

// Billing Portal
message BillingPortalRequest {
  string stripeCustomerId = 1;
  string returnUrl = 2;
}

message BillingPortalResponse {
  string portalUrl = 1;
  bool success = 2;
}

// Cancel Stripe Subscription
message CancelStripeSubscriptionRequest {
  string stripeSubscriptionId = 1;
  optional bool cancelAtPeriodEnd = 2;
}

message CancelSubscriptionResponse {
  bool success = 1;
  string status = 2;
  optional string canceledAt = 3;
  optional string message = 4;
}
